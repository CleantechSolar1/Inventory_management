{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>License Details</h2>
    <h4>{{ license.name }}</h4>
    <p>
        <strong>Total:</strong> {{ license.total_license if license.total_license is not none else license.quantity }} |
        <strong>Remaining:</strong> {{ license.remaining_license if license.remaining_license is not none else '-' }} |
        <strong>Purchase Date:</strong> {{ license.purchase_date or '-' }} |
        <strong>Expiry Date:</strong> {{ license.expiry_date or '-' }} |
        <strong>Amount / Unit:</strong> {{ license.amount_per_unit or '-' }} |
        <strong>Last Renewal:</strong> {{ license.last_renewal_date or '-' }}
    </p>

    {% if details %}
        <h5>Existing Details:</h5>
        <ul class="list-group mb-4">
            {% for detail in details %}
                <li class="list-group-item">
                    <strong>Owner:</strong> {{ detail.current_owner }}<br>
                    <strong>Purchase Date:</strong> {{ detail.purchase_date }}<br>
                    <strong>Expiry Date:</strong> {{ detail.expiry_date }}<br>
                    <strong>Remarks:</strong> {{ detail.remarks }}
                    <div class="mt-2">
                        <a href="{{ url_for('main.edit_license_detail', detail_id=detail.id) }}" class="btn btn-warning btn-sm">Edit</a>
                        <form action="{{ url_for('main.delete_license_detail', detail_id=detail.id) }}" method="POST" style="display:inline;">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this detail?');">Delete</button>
                        </form>
                    </div>
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No existing details found for this license.</p>
    {% endif %}

    {% if missing_details_count > 0 and current_user.can_manage_licenses %}
        <h5>Add Details for Remaining Licenses:</h5>
        <form method="POST" action="{{ url_for('main.license_details', license_id=license.id) }}">
            <input type="hidden" name="form_type" value="detail">
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="current_owner">Current Owner</label>
                        <input type="text" class="form-control" id="current_owner" name="current_owner" required>
                    </div>
                    <div class="form-group">
                        <label for="purchase_date">Purchase Date</label>
                        <input type="date" class="form-control" id="purchase_date" name="purchase_date" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="quantity">Quantity</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="expiry_date">Expire Date</label>
                        <input type="date" class="form-control" id="expiry_date" name="expiry_date" required>
                    </div>
                    <div class="form-group">
                        <label for="remarks">Remarks</label>
                        <textarea class="form-control" id="remarks" name="remarks"></textarea>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Add Details</button>
        </form>
    {% else %}
        <p class="text-success">All details are filled for this license.</p>
    {% endif %}

    <hr>
    <h5>Renewal History</h5>
    {% if renewals %}
    <table class="table table-sm table-bordered">
        <thead>
            <tr>
                <th>Renewal Date</th>
                <th>Amount</th>
                <th>Remarks</th>
            </tr>
        </thead>
        <tbody>
            {% for renewal in renewals %}
            <tr>
                <td>{{ renewal.renewal_date }}</td>
                <td>{{ renewal.amount or '-' }}</td>
                <td>{{ renewal.remarks or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No renewals logged yet.</p>
    {% endif %}

    {% if current_user.can_manage_licenses %}
    <h5 class="mt-3">Add Renewal</h5>
    <form method="POST" action="{{ url_for('main.license_details', license_id=license.id) }}">
        <input type="hidden" name="form_type" value="renewal">
        <div class="row">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="renewal_date">Renewal Date</label>
                    <input type="date" class="form-control" id="renewal_date" name="renewal_date" required>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="amount">Amount</label>
                    <input type="number" step="0.01" class="form-control" id="amount" name="amount">
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="renewal_remarks">Remarks</label>
                    <input type="text" class="form-control" id="renewal_remarks" name="remarks">
                </div>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Add Renewal</button>
    </form>
    {% endif %}

    <a href="{{ url_for('main.licenses') }}" class="btn btn-secondary mt-4">Back to Licenses</a>
</div>
{% endblock %}
